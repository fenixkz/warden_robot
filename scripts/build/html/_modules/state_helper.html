<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>state_helper &mdash; Warden_robot 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Warden_robot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Warden_robot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">state_helper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for state_helper</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: state_helper</span>
<span class="sd">  :platform: Unix</span>
<span class="sd">  :synopsis: Python module for the helpers used in :mod:`state_machine`</span>
<span class="sd">  </span>
<span class="sd">.. moduleauthor:: Ayan Mazhitov mazhitovayan@gmail.com</span>

<span class="sd">Python module that defines three clases of helpers to be used in :mod:`state_machine`: ProtegeHelper(), InterfaceHelper(), ActionClientHelper()</span>
<span class="sd">&quot;&quot;&quot;</span>



<span class="c1"># Import all the necessary libraries</span>
<span class="kn">import</span> <span class="nn">rospy</span> 
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">armor_api.armor_client</span> <span class="kn">import</span> <span class="n">ArmorClient</span>
<span class="kn">from</span> <span class="nn">warden_robot</span> <span class="kn">import</span> <span class="n">architecture_name_mapper</span> <span class="k">as</span> <span class="n">anm</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">actionlib</span> <span class="kn">import</span> <span class="n">SimpleActionClient</span>

<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Bool</span>
<span class="kn">from</span> <span class="nn">warden_robot.msg</span> <span class="kn">import</span> <span class="n">PlanAction</span><span class="p">,</span> <span class="n">ControlAction</span>
<span class="kn">from</span> <span class="nn">warden_robot.srv</span> <span class="kn">import</span> <span class="n">SetPose</span>


<div class="viewcode-block" id="ProtegeHelper"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper">[docs]</a><span class="k">class</span> <span class="nc">ProtegeHelper</span><span class="p">():</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	</span>
<span class="sd">	This class is used by :mod:`state_machine` to help to deal with `armor_py_api &lt;https://github.com/EmaroLab/armor_py_api&gt;`_. Also, loads the following parameters from the ROS param server</span>
<span class="sd">	</span>
<span class="sd">	*    config/ontology_name</span>
<span class="sd">	*    config/ontology_path</span>
<span class="sd">	</span>
<span class="sd">	</span>
<span class="sd">	Attributes</span>
<span class="sd">	----------</span>
<span class="sd">	client: `armor_api.armor_client.ArmorClient`</span>
<span class="sd">		An Armor client from `armor_py_api &lt;https://github.com/EmaroLab/armor_py_api&gt;`_ library to do queries and manipulation with the ontology file</span>
<span class="sd">	</span>
<span class="sd">	Methods</span>
<span class="sd">	----------</span>
<span class="sd">	get_doors_list()</span>
<span class="sd">		Class method to get the list of strings representing each door</span>
<span class="sd">	get_corridors_list()</span>
<span class="sd">		Class method to get the list of strings representing each corridor</span>
<span class="sd">	get_rooms_list()</span>
<span class="sd">		Class method to get the list of strings representing each room</span>
<span class="sd">	get_current_location()</span>
<span class="sd">		Class method to get the current location of the robot</span>
<span class="sd">	load_topological_map()</span>
<span class="sd">		Class method that loads the topologiacl map from the specified path into the buffer</span>
<span class="sd">	add_individual()</span>
<span class="sd">		Class method that adds each individual to the ontology</span>
<span class="sd">	build_map()</span>
<span class="sd">		Class method that builds the map</span>
<span class="sd">	decide_next_location()</span>
<span class="sd">		Class method that uses a certain policy to decide next location for the robot</span>
<span class="sd">	plan_to_recharge_station()</span>
<span class="sd">		Class method that returns the next location to be able to reach the charging station</span>
<span class="sd">	move_robot()</span>
<span class="sd">		Class method that does manipulations to the ontology to move the robot individual to the new location</span>
<span class="sd">	reason()</span>
<span class="sd">		Class method that invokes the ontology&#39;s reasoner</span>
<span class="sd">	canReach()</span>
<span class="sd">		Class method that gives the list of all locations that can be reached by the robot</span>
<span class="sd">	get_urgent_location()</span>
<span class="sd">		Class method that gives the list of urgent locations</span>
<span class="sd">	</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Class constructor. Uses private attributes to ensure data encapsulation. </span>
<span class="sd">		</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		None.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># Initialize the Armor Client</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">ArmorClient</span><span class="p">(</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="s2">&quot;ontoRef&quot;</span><span class="p">)</span>
		<span class="c1"># Define a pair of individuals, each location with the door</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__protege_ind</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;D7&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;D6&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="s1">&#39;D6&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="s1">&#39;D1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="s1">&#39;D5&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="s1">&#39;D2&#39;</span><span class="p">),(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;D5&#39;</span><span class="p">),(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;D4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;D3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;D7&#39;</span><span class="p">),(</span><span class="s1">&#39;R3&#39;</span><span class="p">,</span><span class="s1">&#39;D3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;R1&#39;</span><span class="p">,</span><span class="s1">&#39;D1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;R2&#39;</span><span class="p">,</span><span class="s1">&#39;D2&#39;</span><span class="p">),</span> 					    <span class="p">(</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="s1">&#39;D4&#39;</span><span class="p">)]</span>
		<span class="c1"># Define the rooms of the map</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__rooms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;R&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
		<span class="c1"># Define the corridors of the map</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__corridors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">]</span>
		<span class="c1"># Define the doors of the map</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__doors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)]</span>
		<span class="c1"># Load the name of the ontology from the ROS param server</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__ontology_name</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_ONTOLOGY_NAME</span><span class="p">,</span> <span class="s2">&quot;topological_map.owl&quot;</span><span class="p">)</span>
		<span class="c1"># Load the full path to the ontology from the ROS param server</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_ONTOLOGY_PATH</span><span class="p">,</span> <span class="s2">&quot;/root/ros_ws/src/warden_robot/topological_map&quot;</span><span class="p">)</span>
		<span class="c1"># Attribute to track the current location of the robot</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="c1"># For logging purposes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span> <span class="o">=</span> <span class="s2">&quot;Protege-Helper&quot;</span>
		
<div class="viewcode-block" id="ProtegeHelper.get_doors_list"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.get_doors_list">[docs]</a>	<span class="k">def</span> <span class="nf">get_doors_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that returns the list of string representing each door in the environment.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list</span>
<span class="sd">			List of str for each door in the environment.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__doors</span></div>
		
<div class="viewcode-block" id="ProtegeHelper.get_corridors_list"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.get_corridors_list">[docs]</a>	<span class="k">def</span> <span class="nf">get_corridors_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that returns the list of string representing each corridor in the environment.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list</span>
<span class="sd">			List of str for each corridor in the environment.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corridors</span></div>
		
<div class="viewcode-block" id="ProtegeHelper.get_rooms_list"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.get_rooms_list">[docs]</a>	<span class="k">def</span> <span class="nf">get_rooms_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that returns the list of string representing each room in the environment.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list</span>
<span class="sd">			List of str for each room in the environment.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rooms</span></div>
		
<div class="viewcode-block" id="ProtegeHelper.get_current_location"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.get_current_location">[docs]</a>	<span class="k">def</span> <span class="nf">get_current_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that returns a string representing the current location of the robot.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		str</span>
<span class="sd">			Current location of the robot.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span></div>
		
<div class="viewcode-block" id="ProtegeHelper.load_topological_map"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.load_topological_map">[docs]</a>	<span class="k">def</span> <span class="nf">load_topological_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that loads the ontology. The path and the ontology&#39;s name is specified as parameters in the param server. Also, mounts and sets the log to the terminal.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		int</span>
<span class="sd">			Error code. 1 for success; 0 for the error.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># Get the path</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ontology_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="c1"># If the path exists</span>
			<span class="c1"># Load the ontology</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">load_ref_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;http://bnc/exp-rob-lab/2022-23&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;PELLET&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">mount_on_ref</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_log_to_terminal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># Error</span>
			<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Cannot find the ontology map file. Check the specified path.&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span>
		<span class="k">return</span> <span class="mi">0</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.add_individuals"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.add_individuals">[docs]</a>	<span class="k">def</span> <span class="nf">add_individuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that adds all individuals specified by the class private attribute to the ontology. After adding, it also makes them disjoint</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		None.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># For each pair of location and door add them to ontology</span>
		<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__protege_ind</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">add_objectprop_to_ind</span><span class="p">(</span><span class="s2">&quot;hasDoor&quot;</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="c1"># Make all individuals disjoint</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;DISJOINT&#39;</span><span class="p">,</span> <span class="s1">&#39;IND&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rooms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corridors</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__doors</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.build_map"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.build_map">[docs]</a>	<span class="k">def</span> <span class="nf">build_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that builds the topological map of the environment. First, it invokes :mod:`state_helper.ProtegeHelper.load_topological_map` and :mod:`state_helper.ProtegeHelper.add_individuals`.</span>
<span class="sd">		Also, adds the dataproperty &#39;visitedAt&#39; to each location with the now timestamp. Finally, calls the :mod:`state_helper.ProtegeHelper.reason`.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		int</span>
<span class="sd">			Error code. 1 for success. 0 for error.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_topological_map</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_individuals</span><span class="p">()</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_sec</span><span class="p">())</span>
			<span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rooms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corridors</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">add_dataprop_to_ind</span><span class="p">(</span><span class="s1">&#39;visitedAt&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="s2">&quot;Long&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">()</span>
			<span class="k">return</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Unexpected error. Map has not been built.&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.decide_next_location"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.decide_next_location">[docs]</a>	<span class="k">def</span> <span class="nf">decide_next_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that uses the surveillance policy to decide what should be the next location of the robot. First, it calls :mod:`state_helper.ProtegeHelper.get_urgent_location` </span>
<span class="sd">		to know if there are urgent locations, and :mod:`state_helper.ProtegeHelper.canReach` to know the reachable locations. If no locations became urgent then returns a random reachable location.</span>
<span class="sd">		Else chooses random between the intersection of reachable and urgent locations.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		str</span>
<span class="sd">			String representation of the next location.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># Get the list of urgent locations</span>
		<span class="n">urgent_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_urgent_location</span><span class="p">()</span>
		<span class="c1"># Get the list of reachable locations</span>
		<span class="n">reachable_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canReach</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">urgent_locations</span><span class="p">:</span>
			<span class="c1"># Find what URGENT locations are within the range of the robot</span>
			<span class="n">urgent_reachable_locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">urgent_locations</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">reachable_locations</span><span class="p">]</span>
			<span class="c1"># Pick something random among these locations</span>
			<span class="k">if</span> <span class="n">urgent_reachable_locations</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">urgent_reachable_locations</span><span class="p">)</span> 
		<span class="c1"># If there are no yet urgent locations</span>
		<span class="c1"># Just pick something random among locations that can be reached</span>
		<span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">reachable_locations</span><span class="p">)</span> </div>
	
<div class="viewcode-block" id="ProtegeHelper.plan_to_recharge_station"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.plan_to_recharge_station">[docs]</a>	<span class="k">def</span> <span class="nf">plan_to_recharge_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charging_station</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that checks if the robot is within the location containing the charging station. If not, then returns the closest location to it. </span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		charging_station : str</span>
<span class="sd">			String representation of the location containing the charging station.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		str</span>
<span class="sd">			String representation of the closest location to the charging station.</span>
<span class="sd">		</span>
<span class="sd">		Note</span>
<span class="sd">		----</span>
<span class="sd">		Works only when the charging location is &#39;E&#39;</span>
<span class="sd">		</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="o">==</span> <span class="n">charging_station</span><span class="p">:</span>
			<span class="c1"># If the robot is already in charging location</span>
			<span class="k">return</span> <span class="s2">&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">]:</span>
			<span class="c1"># If the robot is in corridors C1 or C2, then return the charging location</span>
			<span class="k">return</span> <span class="n">charging_station</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
			<span class="c1"># Same logic</span>
			<span class="k">return</span> <span class="s1">&#39;C1&#39;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R3&#39;</span><span class="p">,</span> <span class="s1">&#39;R4&#39;</span><span class="p">]:</span>
			<span class="c1"># Same logic</span>
			<span class="k">return</span> <span class="s1">&#39;C2&#39;</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.move_robot"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.move_robot">[docs]</a>	<span class="k">def</span> <span class="nf">move_robot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that does manipulation to the ontology to replace the object property &#39;isIn&#39; of Robot1 to new location in order to do the logic of moving the robot from one location to another</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		location : str</span>
<span class="sd">			String representation of location where the robot wants to go.</span>
<span class="sd">		time : int</span>
<span class="sd">			Timestamp.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		None.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># Check whether the location given is a string or not</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span><span class="p">:</span> <span class="c1"># For the beginning of the process the robot has no location</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="c1"># Add the object property &#39;isIn&#39; of the robot with the new location</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">add_objectprop_to_ind</span><span class="p">(</span><span class="s1">&#39;isIn&#39;</span><span class="p">,</span> <span class="s1">&#39;Robot1&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Exception thrown try to add object property isIn to the robot&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="c1"># Replace the object property &#39;isIn&#39; of the robot with the new location</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">replace_objectprop_b2_ind</span><span class="p">(</span><span class="s1">&#39;isIn&#39;</span><span class="p">,</span> <span class="s1">&#39;Robot1&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span><span class="p">)</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Exception is thrown try to replace the object property isIn to the robot&quot;</span><span class="p">)</span>
			<span class="c1"># Update the current location</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__current_location</span> <span class="o">=</span> <span class="n">location</span>
			<span class="c1"># Retrieve from the ontology the last timestamp for that location</span>
			<span class="n">timestamp_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">dataprop_b2_ind</span><span class="p">(</span><span class="s2">&quot;visitedAt&quot;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
			<span class="c1"># The output from the query above is not exactly an int, so format it </span>
			<span class="n">timestamp_</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timestamp_last</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="c1"># Replace the data property of that location with the new timestamp</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">replace_dataprop_b2_ind</span><span class="p">(</span><span class="s1">&#39;visitedAt&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="s2">&quot;Long&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">timestamp_</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception is thrown trying to replace data property visitedAt to location </span><span class="si">{0}</span><span class="s2"> with value </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
				<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
			<span class="c1"># Update the now data property of the Robot1</span>
			<span class="n">robot_time_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">dataprop_b2_ind</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">,</span> <span class="s1">&#39;Robot1&#39;</span><span class="p">)</span>
			<span class="n">time_</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">robot_time_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">manipulation</span><span class="o">.</span><span class="n">replace_dataprop_b2_ind</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">,</span> <span class="s1">&#39;Robot1&#39;</span><span class="p">,</span> <span class="s1">&#39;Long&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">time_</span><span class="p">)</span>
			<span class="c1"># Finally call the reasoner</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">()</span>
			
		<span class="k">else</span><span class="p">:</span>
			<span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;The location must be of type string&quot;</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.reason"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.reason">[docs]</a>	<span class="k">def</span> <span class="nf">reason</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that calls the reasoner to update the new changes in the ontology</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		None.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">apply_buffered_changes</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">sync_buffered_reasoner</span><span class="p">()</span></div>
		
<div class="viewcode-block" id="ProtegeHelper.canReach"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.canReach">[docs]</a>	<span class="k">def</span> <span class="nf">canReach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that gives the list of all locations that are within the range of the robot</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list</span>
<span class="sd">			List of strings representing all reachable locations for the robot.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objectprop_b2_ind</span><span class="p">(</span><span class="s2">&quot;canReach&quot;</span><span class="p">,</span> <span class="s1">&#39;Robot1&#39;</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="ProtegeHelper.get_urgent_location"><a class="viewcode-back" href="../index.html#state_helper.ProtegeHelper.get_urgent_location">[docs]</a>	<span class="k">def</span> <span class="nf">get_urgent_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		</span>
<span class="sd">		Method that returns the list of all urgent locations.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list</span>
<span class="sd">			List of strings representing all urgent locations.</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">ind_b2_class</span><span class="p">(</span><span class="s1">&#39;URGENT&#39;</span><span class="p">)</span></div></div>
		
		
		
<div class="viewcode-block" id="ActionClientHelper"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper">[docs]</a><span class="k">class</span> <span class="nc">ActionClientHelper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    Acton Client Helper for ROS actionlib. Implemented by the professor as an example. Taken from the exercise solution</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    service_name : str</span>
<span class="sd">         Name of the service</span>
<span class="sd">    action_type : ROS msg datatype</span>
<span class="sd">         Data structure used by the action server to send the data. </span>
<span class="sd">    done_callback : function</span>
<span class="sd">         Callback for the results</span>
<span class="sd">    feedback_callback : function</span>
<span class="sd">         Feedback callback</span>
<span class="sd">    mutex : threading.Lock</span>
<span class="sd">         A mutex to preserve the consistency of the data</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    send_goal(goal)</span>
<span class="sd">         Class method that sends the goal to the action server</span>
<span class="sd">    cancel_goals()</span>
<span class="sd">         Class method that cancel all the current goals</span>
<span class="sd">    reset_client_states()</span>
<span class="sd">         Class method that resets all the internal states of the action server</span>
<span class="sd">    is_done()</span>
<span class="sd">         Class method that tells if the action has done its routine</span>
<span class="sd">    is_running()</span>
<span class="sd">        Class method that tells if the action server is still doing its routine</span>
<span class="sd">    get_results()</span>
<span class="sd">         Class method that returns the results of the action server</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Class constructor, i.e., class initializer. Input parameters are:</span>
    <span class="c1">#  - `service_name`: it is the name of the server that will be invoked by this client.</span>
    <span class="c1">#  - `action_type`: it is the message type that the server will exchange.</span>
    <span class="c1">#  - `done_callback`: it is the name of the function called when the action server completed its computation. If</span>
    <span class="c1">#     this parameter is not set (i.e., set to `None`), then only the `self._done_callback` function will be</span>
    <span class="c1">#     called when the server completes its computation.</span>
    <span class="c1">#  - `feedback_callback`: it is the name of the function called when the action server sends a feedback message. If</span>
    <span class="c1">#    this parameter is not set (i.e., set to `None`), then only the `self._feedback_callback` functions will be</span>
    <span class="c1">#    called when the server sends a feedback message.</span>
    <span class="c1">#  - `mutex`: it is a `Lock` object synchronised with the `done_callback` and `feedback_callback`. If it is not set</span>
    <span class="c1">#    (i.e., set to `None`), then a new mutex instance is considered. Set this variable if you want to extends the</span>
    <span class="c1">#    synchronization with other classes.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">action_type</span><span class="p">,</span> <span class="n">done_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feedback_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mutex</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Initialise the state of this client, i.e.,  `_is_running`, `_is_done`, and `_results`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_client_states</span><span class="p">()</span>
        <span class="c1"># Set the name of the server to be invoked.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_service_name</span> <span class="o">=</span> <span class="n">service_name</span>
        
        <span class="c1"># Get or create a new mutex.</span>
        <span class="k">if</span> <span class="n">mutex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span> <span class="o">=</span> <span class="n">mutex</span>
        <span class="c1"># Instantiate a simple ROS-based action client.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">SimpleActionClient</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">action_type</span><span class="p">)</span>
        <span class="c1"># Set the done and feedback callbacks defined by the class using this client.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_done_cb</span> <span class="o">=</span> <span class="n">done_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_feedback_cb</span> <span class="o">=</span> <span class="n">feedback_callback</span>
        <span class="c1"># Wait for the action server to be alive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
        <span class="c1"># For logging purposes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span> <span class="o">=</span> <span class="s2">&quot;ActionClient-Helper&quot;</span>
    <span class="c1"># Start the action server with a new `goal`. Note this call is not blocking (i.e., asynchronous performed).</span>
<div class="viewcode-block" id="ActionClientHelper.send_goal"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.send_goal">[docs]</a>    <span class="k">def</span> <span class="nf">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="c1"># A new goal can be given to the action server only if it is not running. This simplification implies that</span>
        <span class="c1"># within the ROS architecture no more than one client can use the same server at the same time.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="c1"># Start the action server.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span>
                                   <span class="n">done_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_done_callback</span><span class="p">,</span>
                                   <span class="n">feedback_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_feedback_callback</span><span class="p">)</span>
            <span class="c1"># Set the client&#39;s states.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="s1">&#39;Warning send a new goal, cancel the current request first!&#39;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">tag_log</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span><span class="p">))</span></div>

    <span class="c1"># Stop the computation of the action server.</span>
<div class="viewcode-block" id="ActionClientHelper.cancel_goals"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.cancel_goals">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The computation can be stopped only if the server is actually computing.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="c1"># Stop the computation.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">cancel_all_goals</span><span class="p">()</span>
            <span class="c1"># Reset the client&#39;s state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_client_states</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="s1">&#39;Warning cannot cancel a not running service!&#39;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">tag_log</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span><span class="p">))</span></div>

    <span class="c1"># Reset the client state variables stored in this class.</span>
<div class="viewcode-block" id="ActionClientHelper.reset_client_states"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.reset_client_states">[docs]</a>    <span class="k">def</span> <span class="nf">reset_client_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="kc">None</span></div>
    <span class="c1"># This function is called when the action server send some `feedback` back to the client.</span>
    <span class="k">def</span> <span class="nf">_feedback_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">):</span>
        <span class="c1"># Acquire the mutex to synchronise the computation concerning the `feedback` message with the other nodes of the architecture.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Eventually, call the method provided by the node that uses this action client to manage a feedback.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_feedback_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_external_feedback_cb</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Realise the mutex to (eventually) unblock ROS-based thread waiting on the same mutex.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c1"># This function is called when the action server finish its computation, i.e., it provides a `done` message.</span>
    <span class="k">def</span> <span class="nf">_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># Acquire the mutex to synchronise the computation concerning the `done` message with the other nodes of the architecture.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the client&#39;s state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">results</span>
            <span class="c1"># Eventually, call the method provided by the node that uses this action client to manage a result.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_done_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_external_done_cb</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c1"># Get `True` if the action server finished is computation, or `False` otherwise.</span>
<div class="viewcode-block" id="ActionClientHelper.is_done"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.is_done">[docs]</a>    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span></div>

    <span class="c1"># Get `True` if the action server is running, or `False` otherwise.</span>
<div class="viewcode-block" id="ActionClientHelper.is_running"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.is_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span></div>

    <span class="c1"># Get the results of the action server, if any, or `None`.</span>
<div class="viewcode-block" id="ActionClientHelper.get_results"><a class="viewcode-back" href="../index.html#state_helper.ActionClientHelper.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_err</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Error: cannot get result for `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_service_name</span><span class="si">}</span><span class="s1">`.&#39;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">tag_log</span><span class="p">(</span><span class="n">log_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>



<div class="viewcode-block" id="InterfaceHelper"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper">[docs]</a><span class="k">class</span> <span class="nc">InterfaceHelper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    A helper class to implement the logic of the surveillance policy.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mutex: `threading.Lock`</span>
<span class="sd">        A mutex that is used for synchronization</span>
<span class="sd">    charging_time: float</span>
<span class="sd">        Time that robot waits until the battery gets recharged. Retrieved from ROS param server by key `config/charging_time`</span>
<span class="sd">    waiting_time: float</span>
<span class="sd">        Time that robot waits in location for surveillance purposes. Retrieve from ROS param server by key `config/waiting_time`</span>
<span class="sd">    randomness: bool</span>
<span class="sd">        Indicates whether the battery is controlled manually or by random sense. Retrieved from ROS param server by key `test/random_sense_active`</span>
<span class="sd">    planner_client: `state_helper.ActionClientHelper`</span>
<span class="sd">        An action server for planning routine</span>
<span class="sd">    controller_client: `state_helper.ActionClientHelper`</span>
<span class="sd">        An action server for controlling the robot</span>
<span class="sd">    LOG_TAG: str</span>
<span class="sd">        Tag used for logging purposes</span>
<span class="sd">        </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    reset_battery()</span>
<span class="sd">        Class method to reset the state of the battery from flow to high</span>
<span class="sd">    get_coord_dict()</span>
<span class="sd">        Class method to get the dictionary of the (location, coordinates)</span>
<span class="sd">    get_charging_location()</span>
<span class="sd">        Class method to get the location where the charging station is set</span>
<span class="sd">    is_battery_low()</span>
<span class="sd">        Class method to know if the battery is low</span>
<span class="sd">    init_robot_pose(point)</span>
<span class="sd">        Class method to initialize the robot&#39; position</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="c1"># Retrieve the parameters that we need from the parameter server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_BATTERY_TIME_CHARGE</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_WAIT_IN_LOCATION</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_location</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_CHARGING_STATION</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomness</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">PARAM_RANDOM_ACTIVE</span><span class="p">,</span>  <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Define the dictionary with attached coordinates to each of the location in the topological map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_location_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="s1">&#39;C1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="s1">&#39;C2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">],</span> <span class="s1">&#39;R3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="s1">&#39;R4&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">]}</span>
        <span class="c1"># Set the initial state involving the `self._battery_low`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_battery</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">TOPIC_BATTERY_LOW</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_battery_callback</span><span class="p">)</span>
        <span class="c1"># Define the clients for the the plan and control action servers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planner_client</span> <span class="o">=</span> <span class="n">ActionClientHelper</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">ACTION_PLANNER</span><span class="p">,</span> <span class="n">PlanAction</span><span class="p">,</span> <span class="n">mutex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_client</span> <span class="o">=</span> <span class="n">ActionClientHelper</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">ACTION_CONTROLLER</span><span class="p">,</span> <span class="n">ControlAction</span><span class="p">,</span> <span class="n">mutex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TAG</span> <span class="o">=</span> <span class="s2">&quot;Interface-Helper&quot;</span>

<div class="viewcode-block" id="InterfaceHelper.reset_battery"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper.reset_battery">[docs]</a>    <span class="k">def</span> <span class="nf">reset_battery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        Method that resets the state of the battery from LOW to HIGH. Also, publishes the new state to the battery topic</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_battery_low</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">TOPIC_BATTERY_LOW</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">latch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_battery_low</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="InterfaceHelper.get_coord_dict"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper.get_coord_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_coord_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        Method that return the dictionary of location and coordinates pair</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary of (Location, coordinates) pairs.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_location_dict</span></div>
        
<div class="viewcode-block" id="InterfaceHelper.get_charging_location"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper.get_charging_location">[docs]</a>    <span class="k">def</span> <span class="nf">get_charging_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        Method that returns the location where the charging station is set</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation of the location.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_location</span></div>
    <span class="c1"># The subscriber to get messages published from the `robot-state` node into the `/state/battery_low/` topic.</span>
    <span class="k">def</span> <span class="nf">_battery_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Acquire the mutex to assure the synchronization with the other subscribers and action clients (this assure data consistency).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the battery level and set the relative state variable encoded in this class.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_battery_low</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Release the mutex to eventually unblock the other subscribers or action servers that are waiting.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<div class="viewcode-block" id="InterfaceHelper.is_battery_low"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper.is_battery_low">[docs]</a>    <span class="k">def</span> <span class="nf">is_battery_low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_battery_low</span></div>

    <span class="c1"># Update the current robot pose stored in the `robot-state` node.</span>
<div class="viewcode-block" id="InterfaceHelper.init_robot_pose"><a class="viewcode-back" href="../index.html#state_helper.InterfaceHelper.init_robot_pose">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_robot_pose</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        Method that sets the initial position of the robot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        point : `warden_robot.msg.Point`</span>
<span class="sd">            x and y coordinates of the initial position of the robot.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Eventually, wait for the server to be initialised.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">SERVER_SET_POSE</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Call the service and set the current robot position.</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">SERVER_SET_POSE</span><span class="p">,</span> <span class="n">SetPose</span><span class="p">)</span>
            <span class="n">service</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>  <span class="c1"># None that the service `response` is not used.</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Setting initial robot position (</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s1">) to the `</span><span class="si">{</span><span class="n">anm</span><span class="o">.</span><span class="n">SERVER_SET_POSE</span><span class="si">}</span><span class="s1">` node.&#39;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">tag_log</span><span class="p">(</span><span class="n">log_msg</span><span class="p">,</span> <span class="s2">&quot;Interface-Helper&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Cannot set current robot position through `</span><span class="si">{</span><span class="n">anm</span><span class="o">.</span><span class="n">SERVER_SET_POSE</span><span class="si">}</span><span class="s1">` server. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="n">anm</span><span class="o">.</span><span class="n">tag_log</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="s2">&quot;Interface-Helper&quot;</span><span class="p">))</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ayan Mazhitov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>